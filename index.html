<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kitchatty</title>
<style>
/* Base layout */
body {
  margin: 0;
  display: flex;
  height: 100vh;
  font-family: "Segoe UI", Arial, sans-serif;
  background: linear-gradient(135deg, #091f36, #0f2862);
  color: #f5f5f5;
  overflow: hidden;
}

/* Sidebar */
#sidebar {
  width: 250px;
  background: rgba(15, 40, 98, 0.95);
  border-right: 1px solid #4f5f76;
  padding: 18px;
  overflow-y: auto;
  backdrop-filter: blur(8px);
  box-shadow: 2px 0 6px rgba(0,0,0,0.3);
}

#sidebar h3 {
  margin: 0 0 14px;
  font-size: 16px;
  font-weight: bold;
  color: #fff;
  border-bottom: 1px solid #4f5f76;
  padding-bottom: 6px;
  letter-spacing: 0.5px;
}

.unread-badge {
  background: #9e363a;
  color: #fff;
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 12px;
  font-weight: bold;
  margin-left: 8px;
}

.online-user {
  padding: 10px 12px;
  border-radius: 10px;
  cursor: pointer;
  margin: 8px 0;
  transition: transform 0.2s, background 0.25s;
  background: rgba(255,255,255,0.05);
  color: #f5f5f5;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.online-user:hover {
  background: rgba(255,255,255,0.15);
  transform: translateX(4px);
}

.online-user.selected {
  background: #4f5f76;
  font-weight: bold;
}

.last-seen {
  font-size: 11px;
  color: #ccc;
  display: block;
  margin-top: 3px;
}

.admin-badge {
  font-size: 11px;
  font-weight: bold;
  color: #ffcc00;
  margin-left: 6px;
}

/* Chat All Button */
#chatAllBtn {
  width: 100%;
  padding: 12px;
  margin-top: 14px;
  border: none;
  background: linear-gradient(90deg, #9e363a, #7a272a);
  color: #fff;
  font-weight: bold;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}
#chatAllBtn:hover {
  transform: scale(1.05);
  box-shadow: 0 3px 10px rgba(158,54,58,0.4);
}

/* Chat container */
#chatContainer {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: linear-gradient(180deg, #091f36, #0f2862);
  color: #f5f5f5;
}

/* Tabs */
#tabs {
  display: flex;
  background: #0f2862;
  border-bottom: 1px solid #4f5f76;
  padding: 6px;
  gap: 8px;
}

.tab {
  padding: 8px 12px;
  cursor: pointer;
  border-right: 1px solid #4f5f76;
  background: rgba(15, 40, 98, 0.9);
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  color: #eee;
  transition: background 0.25s, color 0.25s, transform 0.2s;
  border-radius: 8px;
  gap: 8px;
}
.tab:hover {
  background: #4f5f76;
  transform: translateY(-2px);
}
.tab.active {
  background: #091f36;
  font-weight: 600;
  border-bottom: 3px solid #9e363a;
  color: #fff;
}

.tab .close-btn {
  margin-left: 8px;
  color: #9e363a;
  cursor: pointer;
  font-size: 13px;
  transition: color 0.2s;
}
.tab .close-btn:hover {
  color: #ff5c5c;
}

/* Messages list */
#notesList {
  flex: 1;
  overflow-y: auto;
  padding: 18px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* Message bubbles */
.note-item {
  max-width: 70%;
  padding: 10px 14px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.4;
  position: relative;
  box-shadow: 0 3px 6px rgba(0,0,0,0.25);
  transition: transform 0.2s;
  display: flex;
  gap: 10px;
  align-items: center;
}
.note-item:hover {
  transform: translateY(-2px);
}

.note-item img {
  width: 30px;
  height: 30px;
  border-radius: 50%;
}

.note-item:not(.own-message) {
  align-self: flex-start;
  background: #4f5f76;
  color: #fff;
  border-bottom-left-radius: 4px;
}

.own-message {
  align-self: flex-end;
  background: #0f2862;
  color: #fff;
  border-bottom-right-radius: 4px;
}

.private-message {
  background: #9e363a;
  color: #fff;
  align-self: center;
  border-radius: 12px;
  font-weight: bold;
}

.admin-message {
  border: 2px solid #ffcc00;
  background: #333366;
  font-weight: bold;
}

/* Delete button */
.note-item button {
  margin-left: 10px;
  border: none;
  background: #9e363a;
  color: #fff;
  padding: 4px 8px;
  font-size: 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
}
.note-item button:hover {
  background: #7a272a;
}

/* Chat bar */
#chatBar {
  display: flex;
  padding: 12px;
  background: rgba(79,95,118,0.9);
  align-items: center;
  gap: 8px;
  border-top: 1px solid #333;
  backdrop-filter: blur(6px);
}

#username {
  width: 110px;
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #333;
  background: #091f36;
  color: #fff;
  text-align: center;
  font-size: 13px;
  font-weight: 500;
}

#noteInput {
  flex: 1;
  height: 38px;
  border-radius: 6px;
  border: 1px solid #333;
  padding: 0 12px;
  font-size: 14px;
  background: #0f2862;
  color: #fff;
  transition: border 0.2s, background 0.2s;
}
#noteInput:focus {
  border-color: #9e363a;
  outline: none;
  background: #091f36;
}

#sendBtn, #logoutBtn {
  padding: 0 16px;
  height: 38px;
  border-radius: 6px;
  cursor: pointer;
  background: linear-gradient(90deg, #9e363a, #7a272a);
  color: #fff;
  font-weight: bold;
  border: none;
  transition: transform 0.2s, box-shadow 0.2s;
}
#sendBtn:hover, #logoutBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 3px 10px rgba(158,54,58,0.4);
}
</style>
</head>
<body>

<div id="sidebar">
  <h3>Online Users</h3>
  <div id="onlineUsersList"></div>
  <button id="chatAllBtn" >Chat All</button>
  <button id="editProfileBtn" style="width:100%; padding:12px; margin-top:8px; border:none; background:#4f5f76; color:#fff; font-weight:bold; border-radius:8px; cursor:pointer;" hidden>
  Edit Profile
</button>



  <br><br>
  <input type="color" id="bgSelector" onchange="changeBackground()">
  <p><span style="font-weight: bolder;">Updates/News:</span><br><br>
  <span style="color:#ffcc00;font-weight:bold;">Happy birthday Victor! ðŸŽ‰</span><br><br>
  Now with profile pictures and profanity filter!
  </p>
</div>
<!-- Popup -->
<div id="profilePopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; width:300px; text-align:center; position:relative;">
    <span id="closePopup" style="position:absolute; top:10px; right:15px; cursor:pointer; font-weight:bold;">&times;</span>
    <h3>Edit Profile</h3>
    <input type="text" placeholder="Status" style="width:80%; padding:5px; margin-bottom:10px;" id="userStatus"><br>
    <input type="text" placeholder="Bio" style="width:80%; padding:5px; margin-bottom:10px;" id="userBio"><br>
    <button style="padding:8px 15px; background:#4f5f76; color:#fff; border:none; border-radius:5px; cursor:pointer;">Save</button>
  </div>
</div>
<div id="chatContainer">
  <div id="tabs"></div>
  <div id="notesList"></div>
  <div id="chatBar">
    <input id="username" readonly>
    <input type="text" id="noteInput" placeholder="Write a message...">
    <button id="sendBtn">Send</button>
    <button id="logoutBtn">Logout</button>
  </div>
</div>
<script>
  const editBtn = document.getElementById('editProfileBtn');
  const popup = document.getElementById('profilePopup');
  const closeBtn = document.getElementById('closePopup');

  editBtn.addEventListener('click', () => {
    popup.style.display = 'flex';
  });

  closeBtn.addEventListener('click', () => {
    popup.style.display = 'none';
  });

  // Optional: Close popup if clicking outside the box
  popup.addEventListener('click', (e) => {
    if (e.target === popup) {
      popup.style.display = 'none';
    }
  });

  
</script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBXhiyGWev_pgR04Xqwq-09cE_oyrLWnU8",
  authDomain: "kitisnotebook.firebaseapp.com",
  projectId: "kitisnotebook",
  storageBucket: "kitisnotebook.firebasestorage.app",
  messagingSenderId: "450680847245",
  appId: "1:450680847245:web:2e4ebb71ccd3a7920bdbc4",
  measurementId: "G-W3ZVV6N6KK"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Admin & login
const ADMIN_USER = "kitis";
let isAdmin = false;
const loggedInUser = localStorage.getItem("loggedInUser");
if (!loggedInUser) window.location.href = "login.html";
document.getElementById("username").value = loggedInUser;
if (loggedInUser === ADMIN_USER) isAdmin = true;

// Unread tracking
let unreadCounts = {};
let processedMessageIds = new Set();

// Online users
const onlineUsersList = document.getElementById("onlineUsersList");

async function goOnline() {
  const userRef = doc(db, "onlineUsers", loggedInUser); 
  await setDoc(userRef, { username: loggedInUser, lastActive: Date.now(), avatar: "https://i.pravatar.cc/30?u="+loggedInUser });
}
goOnline();
setInterval(async () => {
  const userRef = doc(db, "onlineUsers", loggedInUser);
  await setDoc(userRef, { username: loggedInUser, lastActive: Date.now(), avatar: "https://i.pravatar.cc/30?u="+loggedInUser }, { merge: true });
}, 30000);
onSnapshot(doc(db, "profiles", loggedInUser), snap => {
  if (snap.exists()) {
    const data = snap.data();
    console.log("Profile updated:", data);
    const userDiv = document.querySelector(`.online-user[data-user="${CSS.escape(loggedInUser)}"]`);
    if (userDiv) {
      userDiv.querySelector("img").src = data.avatar || `https://i.pravatar.cc/30?u=${loggedInUser}`;
      const label = userDiv.querySelector("span");
      if (label) label.textContent = `${loggedInUser} - ${data.status || ""}`;
    }
  }
});
function formatLastSeen(ms) {
  const seconds = Math.floor(ms/1000);
  if (seconds < 60) return "just now";
  const minutes = Math.floor(seconds/60);
  if (minutes < 60) return minutes + " min ago";
  const hours = Math.floor(minutes/60);
  return hours + " hr ago";
}

// Profanity filter
const bannedWords = ["fuck","nigger","nigga", "bitch", "pussy"];
function filterProfanity(text){
  let filtered = text;
  bannedWords.forEach(w => {
    const regex = new RegExp(w,"gi");
    filtered = filtered.replace(regex,"****");
  });
  return filtered;
}

// Render online users
onSnapshot(collection(db, "onlineUsers"), snapshot => {
  onlineUsersList.innerHTML = "";
  const now = Date.now();
  const usersMap = {};
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const user = data.username;
    const lastActive = data.lastActive || 0;
    const avatar = data.avatar || "https://i.pravatar.cc/30?u="+user;
    if (user === loggedInUser) return;
    usersMap[user] = { user, lastActive, avatar };
  });

  const sortedUsers = Object.values(usersMap).sort((a, b) => {
    const aOnline = now - a.lastActive <= 60 * 1000;
    const bOnline = now - b.lastActive <= 60 * 1000;
    if (aOnline && !bOnline) return -1;
    if (!aOnline && bOnline) return 1;
    return b.lastActive - a.lastActive;
  });
// Add "All Chat" as a pseudo-user so it can also get a badge
const allDiv = document.createElement("div");
allDiv.className = "online-user";
allDiv.dataset.user = "all";
allDiv.textContent = "All Chat";

const allHolder = document.createElement("span");
allHolder.className = "unread-holder";
allDiv.appendChild(allHolder);

allDiv.onclick = () => { openTab("all"); };
onlineUsersList.prepend(allDiv); // put it on top
updateUnreadBadge("all");
  sortedUsers.forEach(({ user, lastActive, avatar }) => {
    const div = document.createElement("div");
    div.className = "online-user";
    div.dataset.user = user;

    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.flexDirection = "column";
    const label = document.createElement("span");
    label.textContent = user + (now - lastActive <= 60 * 1000 ? " (online)" : "");
    left.appendChild(label);
    if (now - lastActive > 60 * 1000) {
      const span = document.createElement("span");
      span.className = "last-seen";
      span.textContent = `(last seen ${formatLastSeen(now - lastActive)})`;
      left.appendChild(span);
    }
    div.appendChild(left);

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.alignItems = "center";
    if (user === ADMIN_USER) {
      const badge = document.createElement("span");
      badge.className = "admin-badge";
      badge.textContent = "[ADMIN]";
      right.appendChild(badge);
    }
    const unreadHolder = document.createElement("span");
    unreadHolder.className = "unread-holder";
    right.appendChild(unreadHolder);
    div.appendChild(right);

    const avatarImg = document.createElement("img");
    avatarImg.src = avatar;
    avatarImg.style.marginRight = "8px";
    avatarImg.style.borderRadius = "800px";
    div.prepend(avatarImg);

    div.onclick = () => { openTab(user); };
    onlineUsersList.appendChild(div);
    updateUnreadBadge(user);
  });
});

// Tabs
const tabsContainer = document.getElementById("tabs");
let openTabs = {};
let activeTab = "all";

function openTab(user) {
  if (!openTabs[user]) {
    const tab = document.createElement("div");
    tab.className = "tab" + (user===activeTab ? " active" : "");
    tab.dataset.user = user;
    tab.textContent = user==="all" ? "All Chat" : user;

    if (user !== "all") {
      const closeBtn = document.createElement("span");
      closeBtn.textContent = "âœ–";
      closeBtn.className = "close-btn";
      closeBtn.onclick = (e) => {
        e.stopPropagation();
        tabsContainer.removeChild(tab);
        delete openTabs[user];
        if (activeTab === user) { activeTab = "all"; highlightActiveTab(); displayMessages(); }
      };
      tab.appendChild(closeBtn);
    }

    tab.onclick = () => {
      activeTab = user;
      if (user !== "all" && unreadCounts[user]) {
        unreadCounts[user] = 0;
        updateUnreadBadge(user);
      }
      highlightActiveTab();
      displayMessages();
    };

    openTabs[user] = tab;
    tabsContainer.appendChild(tab);
    updateUnreadBadge(user);
  }
  activeTab = user;
  if (user !== "all" && unreadCounts[user]) {
    unreadCounts[user] = 0;
    updateUnreadBadge(user);
  } 
  highlightActiveTab();
  displayMessages();
}

function highlightActiveTab() {
  Object.values(openTabs).forEach(tab => tab.classList.remove("active"));
  if (openTabs[activeTab]) openTabs[activeTab].classList.add("active");
}

// Messages
const notesList = document.getElementById("notesList");
let allMessages = [];

// Send message
async function sendMessage() {
  let text = document.getElementById("noteInput").value.trim();
  if (!text) return;
  text = filterProfanity(text); // filter
  await addDoc(collection(db, "messages"), { 
    text, from: loggedInUser, to: activeTab, timestamp: Date.now() 
  });
  document.getElementById("noteInput").value="";
}
document.getElementById("sendBtn").onclick = sendMessage;
document.getElementById("noteInput").addEventListener("keydown", e=>{
  if(e.key==="Enter"){ e.preventDefault(); sendMessage(); }
});

// One snapshot listener
const q = query(collection(db,"messages"), orderBy("timestamp"));
onSnapshot(q, snapshot => {
    allMessages = [];
    const now = Date.now();
    snapshot.forEach(async docSnap => {
        const data = docSnap.data();
        if(now - data.timestamp > 10*60*1000) {
            await deleteDoc(doc(db,"messages", docSnap.id));
            return;
        }
        allMessages.push({ id: docSnap.id, data });
    });
    displayMessages();
});

function displayMessages() {
    notesList.innerHTML = "";
    allMessages.forEach(({ id, data }) => {
        if (activeTab === "all") {
            // only broadcast messages
            if (data.to === "all") renderMessage({ id }, data);
        } else {
            // private 1-to-1 messages
            if ((data.from === activeTab && data.to === loggedInUser) ||
                (data.to === activeTab && data.from === loggedInUser)) {
                renderMessage({ id }, data);
            }
        }
    });
    notesList.scrollTop = notesList.scrollHeight;
}


function renderMessage(docSnap, data){
  const div = document.createElement("div");
  div.className="note-item";

  // Avatar
  const avatarImg = document.createElement("img");
  avatarImg.src = `https://i.pravatar.cc/30?u=${data.from}`;
  div.appendChild(avatarImg);

  const content = document.createElement("span");
  content.textContent = `${data.from}: ${data.text}`;
  div.appendChild(content);

  if(data.from===ADMIN_USER) div.classList.add("admin-message");
  if(data.from===loggedInUser) div.classList.add("own-message");
  else if(data.to===loggedInUser && data.to!=="all") div.classList.add("private-message");

  if(data.from===loggedInUser || isAdmin){
    const delBtn=document.createElement("button");
    delBtn.textContent="Delete";
    delBtn.onclick=()=>deleteDoc(doc(db,"messages",docSnap.id));
    div.appendChild(delBtn);
  }
  notesList.appendChild(div);

  const msgId = docSnap.id;
  if (!processedMessageIds.has(msgId)) {
    processedMessageIds.add(msgId);
    if (data.to === loggedInUser && data.from !== loggedInUser && data.to !== "all" && activeTab !== data.from) {
      unreadCounts[data.from] = (unreadCounts[data.from] || 0) + 1;
      updateUnreadBadge(data.from);
    }
  }
}

// Unread badges
function updateUnreadBadge(user) {
  const count = unreadCounts[user] || 0;
  console.log(`Updating badge for ${user}, count = ${count}`);

  const formatCount = (count) => count > 99 ? "99+" : count;

  function createUnreadBadge(count) {
    const badge = document.createElement("span");
    badge.className = "unread-badge";
    badge.textContent = formatCount(count);
    badge.setAttribute("aria-label", `${count} unread message${count === 1 ? "" : "s"}`);
    return badge;
  }

  // --- Update open chat tab ---
  if (openTabs[user]) {
    const tab = openTabs[user];
    let badge = tab.querySelector(".unread-badge");

    if (count > 0) {
      if (!badge) {
        badge = createUnreadBadge(count);
        tab.appendChild(badge);
        console.log("Added badge to tab:", user);
      } else {
        badge.textContent = formatCount(count);
      }
    } else if (badge) {
      badge.remove();
      console.log("Removed badge from tab:", user);
    }
  }

  // --- Update online users list ---
  const userDiv = document.querySelector(`.online-user[data-user="${CSS.escape(user)}"]`);
  if (userDiv) {
    const holder = userDiv.querySelector(".unread-holder");
    if (holder) {
      let badge = holder.querySelector(".unread-badge");

      if (count > 0) {
        if (!badge) {
          badge = createUnreadBadge(count);
          holder.appendChild(badge);
          console.log("Added badge to online list:", user);
        } else {
          badge.textContent = formatCount(count);
        }
      } else if (badge) {
        badge.remove();
        console.log("Removed badge from online list:", user);
      }
    } else {
      console.warn("No .unread-holder inside", userDiv);
    }
  } else {
    console.warn("No .online-user div found for", user);
  }
}

// Init
document.getElementById("chatAllBtn").onclick = () => openTab("all");
openTab("all");

// Logout
document.getElementById("logoutBtn").onclick = async ()=>{
  await deleteDoc(doc(db,"onlineUsers",loggedInUser));
  localStorage.removeItem("loggedInUser");
  window.location.href="login.html";
};


</script>

<script>
function changeBackground() {
  const notesList2 = document.getElementById("notesList");
  const backgroundColorVAR = document.getElementById("bgSelector");
  const backgroundColorVARValue = backgroundColorVAR.value;
  notesList2.style.backgroundColor = backgroundColorVARValue;
}

</script>
</body>
</html>

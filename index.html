<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/style.css">
  <title>Kitis's Chatroom</title>
  <style>
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #chatContainer {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: #f7f7f7;
    }
    #chatBar {
      display: flex;
      padding: 10px;
      background: white;
      border-top: 1px solid #ccc;
    }
    #chatBar input, #chatBar textarea {
      flex: 1;
      padding: 10px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    #chatBar button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background: rgb(0, 207, 207);
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .note-item {
      padding: 6px;
      margin-bottom: 5px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .note-item.own {
      background: #e1fff1;
    }
    .delBtn {
      margin-left: 10px;
      background: red;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Kitis's Chatroom</h1>

  <!-- Username login -->
  <div id="loginContainer">
    <input id="username" placeholder="Enter username">
    <button id="loginBtn">Login</button>
  </div>

  <!-- Online users -->
  <h3>Online Users:</h3>
  <div id="onlineUsers"></div>

  <!-- Messages -->
  <h2>Messages:</h2>
  <div id="chatContainer"></div>

  <!-- Chat bar -->
  <div id="chatBar">
    <textarea id="noteInput" placeholder="Write a message..."></textarea>
    <button id="saveBtn">Send</button>
    <button id="logoutBtn">Logout</button>
  </div>

  <script type="module">
    import { 
      initializeApp 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, where, getDocs, updateDoc 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBXhiyGWev_pgR04Xqwq-09cE_oyrLWnU8",
      authDomain: "kitisnotebook.firebaseapp.com",
      projectId: "kitisnotebook",
      storageBucket: "kitisnotebook.firebasestorage.app",
      messagingSenderId: "450680847245",
      appId: "1:450680847245:web:2e4ebb71ccd3a7920bdbc4",
      measurementId: "G-W3ZVV6N6KK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUser = null;

    // --- LOGIN ---
    async function loginUser(username) {
      const usersRef = collection(db, "users");
      const q = query(usersRef, where("username", "==", username));
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        await addDoc(usersRef, { username, online: true });
      } else {
        snapshot.forEach(async (docSnap) => {
          await updateDoc(doc(db, "users", docSnap.id), { online: true });
        });
      }

      currentUser = username;
      localStorage.setItem("currentUser", username);
      document.getElementById("loginContainer").style.display = "none";
    }

    // --- LOGOUT ---
    async function logoutUser() {
      if (!currentUser) return;

      const usersRef = collection(db, "users");
      const q = query(usersRef, where("username", "==", currentUser));
      const snapshot = await getDocs(q);

      snapshot.forEach(async (docSnap) => {
        await updateDoc(doc(db, "users", docSnap.id), { online: false });
      });

      localStorage.removeItem("currentUser");
      currentUser = null;
      document.getElementById("loginContainer").style.display = "block";
    }

    window.addEventListener("beforeunload", logoutUser);

    // --- SAVE MESSAGE ---
    async function saveNote() {
      const noteInput = document.getElementById("noteInput").value.trim();
      if (!currentUser || !noteInput) return alert("Please login and enter a message.");

      await addDoc(collection(db, "notes"), { 
        user: currentUser,
        text: noteInput,
        createdAt: Date.now()
      });

      document.getElementById("noteInput").value = "";
    }

    // --- DELETE MESSAGE (only own) ---
    async function deleteNote(id, user) {
      if (user !== currentUser) return alert("You can only delete your own messages.");
      await deleteDoc(doc(db, "notes", id));
    }

    // --- REALTIME MESSAGES ---
    function setupRealtimeNotes() {
      const chatContainer = document.getElementById("chatContainer");

      onSnapshot(collection(db, "notes"), (snapshot) => {
        chatContainer.innerHTML = "";
        let notes = [];

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          notes.push({ id: docSnap.id, ...data });
        });

        // Sort by time
        notes.sort((a, b) => a.createdAt - b.createdAt);

        notes.forEach((note) => {
          const div = document.createElement("div");
          div.className = "note-item";
          if (note.user === currentUser) div.classList.add("own");

          const p = document.createElement("p");
          p.textContent = `${note.user}: ${note.text}`;
          div.appendChild(p);

          // delete button only for own messages
          if (note.user === currentUser) {
            const delBtn = document.createElement("button");
            delBtn.textContent = "Delete";
            delBtn.className = "delBtn";
            delBtn.onclick = () => deleteNote(note.id, note.user);
            div.appendChild(delBtn);
          }

          chatContainer.appendChild(div);
        });

        // Auto-scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
      });
    }

    // --- REALTIME ONLINE USERS ---
    function setupRealtimeUsers() {
      const onlineUsersDiv = document.getElementById("onlineUsers");

      onSnapshot(collection(db, "users"), (snapshot) => {
        onlineUsersDiv.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          if (data.online) {
            const p = document.createElement("p");
            p.textContent = data.username;
            onlineUsersDiv.appendChild(p);
          }
        });
      });
    }

    // --- EVENTS ---
    document.getElementById("loginBtn").onclick = () => {
      const username = document.getElementById("username").value.trim();
      if (username) loginUser(username);
    };

    document.getElementById("saveBtn").onclick = saveNote;
    document.getElementById("logoutBtn").onclick = logoutUser;

    // Enter key sends message
    document.getElementById("noteInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        saveNote();
      }
    });

    // --- INIT ---
    setupRealtimeNotes();
    setupRealtimeUsers();

    // auto-login if stored
    const savedUser = localStorage.getItem("currentUser");
    if (savedUser) {
      loginUser(savedUser);
    }
  </script>
</body>
</html>

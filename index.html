<!DOCTYPE html>
<html>
<head>
  <title>Chatroom</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      margin: 0;
      background: #f0f0f0;
    }
    #sidebar {
      width: 200px;
      background: #eee;
      padding: 10px;
      overflow-y: auto;
    }
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #tabsContainer {
      display: flex;
      gap: 5px;
      background: #ddd;
      padding: 5px;
      overflow-x: auto;
    }
    .tab {
      padding: 5px 10px;
      border-radius: 5px;
      background: #bbb;
      cursor: pointer;
      white-space: nowrap;
    }
    .tab.active {
      background: #4CAF50;
      color: white;
    }
    .tab .badge {
      background: red;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 12px;
      margin-left: 5px;
    }
    #notesList {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: white;
    }
    #inputBar {
      display: flex;
      padding: 10px;
      background: #eee;
    }
    #messageInput {
      flex: 1;
      padding: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      margin-left: 5px;
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
    .online-user {
      cursor: pointer;
      margin: 2px 0;
    }
    .online-user.selected {
      font-weight: bold;
      color: green;
    }
    .last-seen {
      font-size: 0.8em;
      color: gray;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Online Users</h3>
    <div id="onlineUsersList"></div>
    <button onclick="logout()">Logout</button>
  </div>

  <div id="main">
    <div id="tabsContainer">
      <div class="tab active" data-user="all">All</div>
    </div>
    <div id="notesList"></div>
    <div id="inputBar">
      <input type="text" id="messageInput" placeholder="Type a message...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const loggedInUser = localStorage.getItem("loggedInUser");
    if (!loggedInUser) window.location.href = "login.html";

    const notesList = document.getElementById("notesList");
    const messageInput = document.getElementById("messageInput");
    const onlineUsersList = document.getElementById("onlineUsersList");
    const tabsContainer = document.getElementById("tabsContainer");

    let selectedUser = "all";

    // ---- Tabs System ----
    function openTab(username) {
      if (!document.querySelector(`.tab[data-user="${username}"]`)) {
        const tab = document.createElement("div");
        tab.className = "tab";
        tab.dataset.user = username;
        tab.textContent = username;
        tab.onclick = () => {
          selectedUser = username;
          highlightTabs();
          displayMessages();
          clearBadge(username);
        };
        tabsContainer.appendChild(tab);
      }
    }

    function highlightTabs() {
      document.querySelectorAll(".tab").forEach(tab => {
        tab.classList.remove("active");
        if (tab.dataset.user === selectedUser) tab.classList.add("active");
      });
    }

    function addBadge(username) {
      let tab = document.querySelector(`.tab[data-user="${username}"]`);
      if (!tab) openTab(username);
      let badge = tab.querySelector(".badge");
      if (!badge) {
        badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent = "1";
        tab.appendChild(badge);
      } else {
        badge.textContent = parseInt(badge.textContent) + 1;
      }
    }

    function clearBadge(username) {
      const tab = document.querySelector(`.tab[data-user="${username}"]`);
      if (tab) {
        const badge = tab.querySelector(".badge");
        if (badge) badge.remove();
      }
    }

    // ---- Notifications ----
    if (Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    function notifyUser(from, message) {
      if (Notification.permission === "granted" && document.hidden) {
        new Notification(`Message from ${from}`, { body: message });
      }
    }

    // ---- Firestore Messages ----
    const q = query(collection(db, "messages"), orderBy("timestamp"));
    let allMessages = [];

    onSnapshot(q, snapshot => {
      allMessages = [];
      snapshot.forEach(docSnap => {
        allMessages.push(docSnap.data());
      });
      displayMessages();
    });

    function displayMessages() {
      notesList.innerHTML = "";
      allMessages.forEach(msg => {
        if (selectedUser === "all") {
          if (!msg.to || msg.to === "all") renderMessage(msg);
        } else if (
          (msg.from === loggedInUser && msg.to === selectedUser) ||
          (msg.from === selectedUser && msg.to === loggedInUser)
        ) {
          renderMessage(msg);
        }
        // Notification + badge for unseen messages
        if (msg.to === loggedInUser && msg.from !== loggedInUser) {
          if (selectedUser !== msg.from) {
            addBadge(msg.from);
            notifyUser(msg.from, msg.text);
          }
          openTab(msg.from);
        }
      });
    }

    function renderMessage(msg) {
      const div = document.createElement("div");
      div.textContent = `${msg.from}: ${msg.text}`;
      notesList.appendChild(div);
    }

    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      await addDoc(collection(db, "messages"), {
        text,
        from: loggedInUser,
        to: selectedUser === "all" ? "all" : selectedUser,
        timestamp: Date.now()
      });
      messageInput.value = "";
    }

    // ---- Online Users ----
    async function goOnline() {
      const userRef = doc(db, "onlineUsers", loggedInUser); 
      await setDoc(userRef, { username: loggedInUser, lastActive: Date.now() });
    }
    goOnline();
    setInterval(async () => {
      const userRef = doc(db, "onlineUsers", loggedInUser);
      await setDoc(userRef, { username: loggedInUser, lastActive: Date.now() }, { merge: true });
    }, 30000);

    onSnapshot(collection(db, "onlineUsers"), snapshot => {
      onlineUsersList.innerHTML = "";
      const now = Date.now();
      const usersMap = {};

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const user = data.username;
        const lastActive = data.lastActive || 0;
        if (user === loggedInUser) return;
        if (!usersMap[user] || usersMap[user].lastActive < lastActive) {
          usersMap[user] = { user, lastActive };
        }
      });

      const sortedUsers = Object.values(usersMap).sort((a, b) => b.lastActive - a.lastActive);

      sortedUsers.forEach(({ user, lastActive }) => {
        const div = document.createElement("div");
        div.className = "online-user" + (selectedUser === user ? " selected" : "");
        if (now - lastActive <= 60000) {
          div.textContent = user + " (online)";
        } else {
          div.textContent = user;
          const span = document.createElement("span");
          span.className = "last-seen";
          span.textContent = `(last seen ${Math.floor((now - lastActive) / 60000)} min ago)`;
          div.appendChild(span);
        }
        div.onclick = () => {
          selectedUser = user;
          openTab(user);
          highlightTabs();
          displayMessages();
          clearBadge(user);
        };
        onlineUsersList.appendChild(div);
      });
    });

    // ---- Logout ----
    function logout() {
      localStorage.removeItem("loggedInUser");
      window.location.href = "login.html";
    }
    window.logout = logout;
    window.sendMessage = sendMessage;
  </script>
</body>
</html>
